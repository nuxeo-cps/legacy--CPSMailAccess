<html metal:use-macro="here/main_template/macros/master">
  <metal:block fill-slot="css_slot">
    <style type="text/css" media="all"
      tal:content="string:@import url(${context/portal_url}/++resource++cpsmailaccess.css);"/>
  </metal:block>
  <metal:main fill-slot="javascript_head_slot">
    <script type="text/javascript"
      tal:attributes="src string:${context/portal_url}/++resource++cpsmailaccess.js;"
      src="++resource++cpsmailaccess.js">
    </script>
    <script type="text/javascript" src="epoz_script_main.js">
    </script>
  </metal:main>
  <metal:block metal:fill-slot="main"
               tal:define="attaching request/attach|nothing">
      <div  tal:condition="attaching">
        <a href="editMessage.html"
           class="close_attach_form"
           title="close">
          <img src="cpsma_delete_file.png"/>
        </a>
        <form class="attach_form"
              action="attach_file"
              method="post" enctype="multipart/form-data">
          <input type="hidden" value="1" name="attach"/>
          <table>
            <tr>
              <td width="100%">
                <input class="attach_name" type="file" name="file"/>
              </td>
              <td>
                <input class="attach_button" type="submit" name="submit"
                    value="attach"/>
              </td>
            </tr>
          </table>
        </form>
       </div>

      <form action="editAction"
            method="post"
            enctype="multipart/form-data"
          tal:define="dummy here/initMessage;
                      came_from request/came_from|nothing;
                      body_value here/bodyvalue;
                      from_indentities here/getIdentitites;"
          >

      <input type="hidden" tal:attributes="value came_from" name="came_from"/>

      <input tal:condition="python:len(from_indentities) == 1"
             type="hidden" tal:attributes="value python:'%s <%s>' %
              (from_indentities[0]['fullname'],from_indentities[0]['email'])"
             name="msg_from"/>

      <table width="100%" class="editor_header">
        <tr tal:condition="python:len(from_indentities) &gt; 1">
          <td class="tr_title">
           From
          </td>
          <td  colspan="2">
            <select style="width: 100%" name="msg_from" id="msg_from">
              <tal:block tal:repeat="from_indenty from_indentities">
                <option tal:attributes="value from_indenty/email">
                  <span tal:replace="from_indenty/fullname"/> &lt;<span
                    tal:replace="from_indenty/email"/>&gt;
                </option>
              </tal:block>
            </select>
          </td>
        </tr>
        <tr tal:repeat="to here/tos">
          <td colspan="1"  class="tr_title">
            &#160;<span tal:replace="to/type"/>
          </td>
          <td class="tr_title" colspan="2">
            <a style="float:right"
               tal:attributes="href python:'removeRecipient?value='+to['value']+'&type='+to['type']">
              <img src="cpsma_delete_file.png"/>
            </a>
            <span tal:replace="to/value"/>

          </td>
        </tr>
        <tr>
          <td>
            <select name="sent_type" style="width: 100%" class="tr_title">
              <option value="To" selected>To</option>
              <option value="Cc">Cc</option>
              <option value="BCc">BCc</option>
            </select>
          </td>
          <td width="100%">
            <input class="message_edit_input" id="msg_to" name="msg_to" type="text"/>
          </td>
          <td>
            <input style="margin-left : 4px" type="submit"
              onclick="saveMessageDatas(GetHTML())"
              name="action" value="add_recipient"/>
          </td>
        </tr>
        <tr>
          <td class="tr_title">Subject:
          </td>
          <td colspan="2">
            <input class="message_edit_input" type="text" name="msg_subject"
                id="msg_subject"
                tal:attributes="value here/subject" />
          </td>
        </tr>
      </table>

      <div id="Body">
       <script type="text/javascript" src="" tal:attributes="src string:fckeditor.js">
    </script>

       <tal:block replace="structure python:here.Epoz(
            name='msg_body', data=body_value, lang='en',
            style='width:100%; height:300px; border:1px solid #A0A0A0; border-style:solid;')" />


      </div>
      <div id="toolbar">
        <input type="submit" value="send" name="action"/>
      </div>
    </form>
  </metal:block>
</html>

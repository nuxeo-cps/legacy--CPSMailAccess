<html metal:use-macro="here/main_template/macros/master">
  <metal:block fill-slot="css_slot">
    <style type="text/css" media="all"
      tal:content="string:@import url(${context/portal_url}/++resource++cpsmailaccess.css);"/>
  </metal:block>
  <metal:main fill-slot="javascript_head_slot">
    <script type="text/javascript"
      tal:attributes="src string:${context/portal_url}/++resource++cpsmailaccess.js;"
      src="++resource++cpsmailaccess.js">
    </script>
  </metal:main>
  <metal:block metal:fill-slot="main"
               tal:define="attaching request/attach|nothing;
                           cc_on python:here.getFlag('cc_on');
                           bcc_on python:here.getFlag('bcc_on');
                           attacher_on python:here.getFlag('attacher_on')">

      <noscript>
        <div class="message">
        Javascript is disabled, please activate it for enhanced ergonomy.
        </div>
      </noscript>
      <div id="attacher"
       tal:attributes="style python:test(attacher_on==0,'visibility: hidden','visibility: visible');class python:test(attacher_on==0,'hidden_part','')">
        <form class="attach_form"
              action="attachFile.html"
              method="post" enctype="multipart/form-data">
          <input type="hidden" value="1" name="attach"/>
          <table>
            <tr>
              <td width="100%">
                <input class="attach_name" type="file" name="file"/>
              </td>
              <td>
                <input class="attach_button" type="submit" name="submit"
                    value="attach"
                    onmouseover="setCursor(this);"
                    onclick="saveMessageDatas()"/>
              </td>
            </tr>
          </table>
        </form>
       </div>

      <form action="editAction.html"
            method="post"
            enctype="multipart/form-data"
            tal:define="dummy here/initMessage;
                      came_from request/came_from|nothing;
                      body_value here/getBodyValue;
                      from_indentities here/getIdentitites;">

      <input type="hidden" tal:attributes="value came_from" name="came_from"/>

      <input tal:condition="python:len(from_indentities) == 1"
             type="hidden" tal:attributes="value python:'%s <%s>' %
              (from_indentities[0]['fullname'],from_indentities[0]['email'])"
             name="msg_from"/>

      <table width="100%" class="editor_header">
        <tr tal:condition="python:len(from_indentities) &gt; 1">
          <td class="tr_title">
           From
          </td>
          <td  colspan="2">
            <select style="width: 100%" name="msg_from" id="msg_from">
              <tal:block tal:repeat="from_indenty from_indentities">
                <option tal:attributes="value from_indenty/email">
                  <span tal:replace="from_indenty/fullname"/> &lt;<span
                    tal:replace="from_indenty/email"/>&gt;
                </option>
              </tal:block>
            </select>
          </td>
        </tr>
        <tr>
         <td colspan="3">
           <div id="To" tal:define="elements python:here.getDestList(type_='To');
                                    elements python:'\r\n'.join(elements)">
             <div class="recipient_header">To:</div>
             <div  class="recipient">
               <textarea name="msg_to" id="msg_to"
                         class="recipients" tal:content="elements"></textarea>
             </div>
           </div>
           <div style="clear: both"/>

           <div id="Cc"
            tal:attributes="style python:test(cc_on==0,'visibility: hidden','visibility: visible');class python:test(cc_on==0,'hidden_part','')"
                tal:define="elements python:here.getDestList(type_='Cc');
                                    elements python:'\r\n'.join(elements)">
             <div class="recipient_header">Cc:</div>
             <div  class="recipient">
               <textarea name="msg_cc"  id="msg_cc"
                         class="recipients" tal:content="elements"></textarea>
             </div>
           </div>

           <div style="clear: both"/>
           <div id="BCc"
                tal:attributes="style python:test(bcc_on==0,'visibility: hidden','visibility: visible');
                class python:test(bcc_on==0,'hidden_part','')"
                tal:define="elements python:here.getDestList(type_='BCc');
                                    elements python:'\r\n'.join(elements)">
             <div class="recipient_header">BCc:</div>
             <div  class="recipient">
               <textarea name="msg_bcc" id="msg_bcc"
                         class="recipients" tal:content="elements"></textarea>
             </div>
           </div>

            <div class="recipient_toggler">
                <span class="link" onmouseover="setCursor(this);"
                      onclick="toggleElementVisibility('attacher')">
                <img src="cma_small_attach.png"/>&#160;Attach file</span> |
                <span class="link" onmouseover="setCursor(this);"
                    onclick="toggleElementVisibility('Cc')">Cc</span> |
                <span class="link" onmouseover="setCursor(this);"
                    onclick="toggleElementVisibility('BCc')">Bcc</span> |
                <span class="link" onmouseover="setCursor(this);"
                    onclick="popupRecipientPicker()">Directories</span>
            </div>
        </td>

        </tr>

        <tr>
          <td colspan="3">
          <div class="subject">Subject:</div>
          <div class="message_edit_input">
            <input class="message_edit_input" type="text" name="msg_subject"
                id="msg_subject"
                tal:attributes="value here/getSubject" />
          </div>
          </td>
        </tr>
      </table>

      <div id="Body">
       <!--
       <tal:block replace="structure python:here.Epoz(
            name='msg_body', data=body_value, lang='en',
            style='width:100%; height:300px; border:1px solid #A0A0A0; border-style:solid;')" />
       -->
       <textarea id="msg_body" tal:content="body_value" name="msg_body"
           style="width:100%; height:300px; border:1px solid #A0A0A0; border-style:solid;" />
      </div>
      <div id="toolbar">
        <input type="submit" value="send" name="action"
         onclick="saveMessageDatas()"/>
      </div>
    </form>
  </metal:block>
</html>

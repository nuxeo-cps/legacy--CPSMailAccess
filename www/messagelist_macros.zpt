<html>
  <body>
    <metal:block define-macro="search_messagelist">
        <table id="tableMessageList">
          <tr class="mailHeaders">
            <th class="mailToolBarElement mailToolBarInsideElement">
                  Subject
            </th>
            <th class="mailToolBarElement mailToolBarInsideElement">
              Sender
            </th>
            <th class="mailToolBarElement mailToolBarInsideElement">
              Date
            </th>
          </tr>
          <tr tal:repeat="result results">
            <td>
              <img src="cpsma_message.png"/>
              <a tal:attributes="href python:result['path']+'/view'">
                <span class="truncable" tal:content="result/Subject|string:?"/>
              </a>
            </td>
            <td>
              <a tal:attributes="href python:result['path']+'/view'">
                <span class="truncable" tal:content="result/From|string:?"/>
              </a>
            </td>
            <td>
              <a tal:attributes="href python:result['path']+'/view'">
                <span class="truncable" tal:content="result/Date|string:?"/>
              </a>
            </td>
          </tr>
        </table>
    </metal:block>

    <metal:block define-macro="messagelist"
                 tal:define="page request/page|python:1;
                             nb_items request/nb_items|python:20;
                             sort_with request/sort_with|python:'Date';
                             sort_asc request/sort_asc|python:0;"
                           >
    <tal:block tal:define="messagesl python:test(keep_last_sort,
                                                 view.renderMailList(keep_last_sort=1),
                                                 view.renderMailList(int(page), int(nb_items),
                                                                     sort_with, int(sort_asc),
                                                                     keep_last_sort));
                           messages python:messagesl[1];
                           nbpages python:messagesl[0];
                           last_sort python:view.getLastMailListSortCache();
                           page python:test(last_sort, last_sort[0], page);
                           nb_items python:test(last_sort, last_sort[1], nb_items);
                           sort_with python:test(last_sort, last_sort[2], sort_with);
                           sort_asc python:test(last_sort, last_sort[3], sort_asc)">

       <div tal:attributes="class
              python:test(is_folder,'folder_msglist','message_msglist')">
        <table id="tableMessageList"
               tal:define="cols here/getMessageListCols"
               class="messageList">
          <tr class="mailHeaders">
            <th tal:condition="content_managment">
            &#160;
            </th>
            <th class="mailToolBarElement mailToolBarInsideElement"
                tal:repeat="col cols">
              <tal:block tal:define="sort_order
                                     python:test(sort_with==col, not int(sort_asc),
                                     int(sort_asc));
                                     sort_order python:test(sort_order, 1, 0)">
                <a tal:attributes="href
                python:here.absolute_url()+'/view?page=%s&nb_items=%s&sort_with=%s&sort_asc=%s'
                %(page, nb_items, col, sort_order)">

                <tal:block tal:condition="python:col not in ('Attachments', 'Icon')">
                    <span tal:replace="col"/>
                </tal:block>
                <tal:block tal:condition="python:col=='Attachments'">
                    A
                </tal:block>
                <tal:block tal:condition="python:col=='Icon'">
                    I
                </tal:block>
                <tal:block tal:condition="python:sort_with==col">
                  <tal:block tal:condition="python:int(sort_asc)==0">^</tal:block>
                  <tal:block tal:condition="python:int(sort_asc)==1">v</tal:block>
                </tal:block>
                </a>
              </tal:block>
            </th>
          </tr>
          <tal:block tal:repeat="message messages">
          <tal:block tal:define="is_current
                python:here.absolute_url()+'/view'==message['url'];
                odd repeat/message/odd;
                class_selected python:test(odd, 'selected_odd', 'selected_even');
                class_not_selected python:test(odd,
                    'not_selected_odd', 'not_selected_even');
                gotoUrl python:message['url'];
                onmouseover python:'setCursor(this)'+chr(59);
                onclickurl python:'gotoUrl('+chr(34)+gotoUrl+chr(34)+')';
                base_url here/getBaseUrl;
                new_message python:message['new'];
                textstyle python:test(new_message, 'newMessage', 'seenMessage');
                divclass python:test(is_current, class_selected, class_not_selected)">

          <tr tal:attributes="class
              python:test(odd, 'line_selectable_odd', 'line_selectable_even');">

            <td tal:condition="content_managment">

              <input type="checkbox" id="check"
                     tal:attributes="name python:'msg_'+message['uid']"/>
            </td>
            <td tal:repeat="col cols">
             <div class="cellDrag" tal:attributes="id python:'msg_'+message['folder_id_uid']">
             <div tal:attributes="class divclass;
                                  onclick onclickurl;
                                  onmouseover onmouseover">

              <a tal:attributes="href python:message['url']">

                <tal:block tal:condition="python:col=='Attachments'">
                  <img src="cpsma_attach_mini.png" tal:condition="python:message[col]==1"/>
                </tal:block>
                <tal:block tal:condition="python:col=='Size'">
                  <span tal:attributes="class textstyle"
                        tal:content="python:str(message[col][0])+' '+message[col][1]"/>
                </tal:block>
                <tal:block tal:condition="python:col=='Icon'">
                  <img tal:attributes="src python:base_url+message[col]"
                       src="cpsma_message.png"/>
                </tal:block>
                <tal:block tal:condition="python:col not in ('Attachments', 'Size', 'Icon')">
                 <span tal:attributes="class python:textstyle+' truncable'"
                       tal:content="python:message[col]"/>
                </tal:block>
              </a>
              </div>
              </div>
            </td>
          </tr>
          </tal:block>
          </tal:block>
        </table>
        <div class="batcher" tal:condition="python:nbpages &gt; 1">
          pages :
          <tal:block tal:repeat="i python:range(nbpages)">
            <tal:block tal:condition="python:i+1==int(page)">
              <span tal:replace="python:i+1"/>
            </tal:block>
            <tal:block tal:condition="python:i+1!=int(page)">

              <a tal:attributes="href
              python:here.absolute_url()+'/view?page=%s&nb_items=%s&sort_with=%s&sort_asc=%s'
              %(i+1, nb_items, sort_with, sort_asc)">
                <span tal:replace="python:i+1"/>
              </a>
            </tal:block>
          </tal:block>
        </div>
      </div>
    </tal:block>
    </metal:block>

    <metal:block define-macro="messagetoolbar">
      <div class="mailToolBar"
           tal:define="folder python:here.getMailFolder()">
          <a tal:condition="folder" style="float: right; margin-right: 4px"
             i18n:attributes="title"
             tal:attributes="href python:folder.absolute_url()+'/view';
                             title string:Back to folder">
            <img id="new_page" src="cpsma_back.png"/>
          </a>
          <a style="float: right; margin-right: 4px"
             i18n:attributes="title"
             tal:attributes="href python:here.absolute_url()+'/viewAlone.html';
                             title string:In a new page"
             target="_blank">
            <img id="new_page" src="launch.png"/>
          </a>
        <tal:block tal:condition="request/showfolders|python:0">
            <a  i18n:attributes="title"
                tal:attributes="href python:here.absolute_url()+'/view';
                                title string:In a new page">
            <img id="fullPageButton" src="cpsma_up.png" style="margin-right: 4px"/>
            </a>
        </tal:block>

        </div>
    </metal:block>

    <metal:block define-macro="messageheaders">
    <img id="imgMailMoreInfos" src="cpsma_lessinfos.png"
               onclick="switchMailHeadersState();"/>
          <div id="mailLessInfos">

          <div id="mailSubject">
            <b>
              <tal:block i18n:translate="cpsma_subject">Subject :</tal:block>
              <tal:block tal:replace="structure view/renderSubject" />
            </b>
          </div>
        </div>
        <div id="mailBreak"/>
        <div id="mailMoreInfos">
          <div id="mailDate">
            <b>
              <tal:block i18n:translate="cpsma_date">Date :</tal:block>
              <tal:block tal:replace="view/renderDate" />
            </b>
          </div>
          <div id="mailFrom" tal:condition="python:view.fromCount()>0">
            <b>
              <tal:block i18n:translate="cpsma_from">From :</tal:block>
              <a tal:attributes="href python:'view#'">
                <tal:block tal:replace="view/renderFromList" />
              </a>
            </b>
          </div>
          <div id="mailTo" tal:condition="python:view.toCount()>0">
            <b>
              <tal:block i18n:translate="cpsma_to">To :</tal:block>
              <a tal:attributes="href python:'view#'">
                <tal:block tal:replace="view/renderToList" />
              </a>
            </b>
          </div>
          <div id="mailCc" tal:condition="python:view.ccCount()>0">
            <b>
              <tal:block i18n:translate="cpsma_cc">Cc :</tal:block>
              <a tal:attributes="href python:'view#'">
                <tal:block tal:replace="view/renderCcList" />
              </a>
            </b>
          </div>
        </div>
      </metal:block>
  </body>
</html>